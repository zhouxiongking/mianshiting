<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>上传视频</title>
    
<meta http-equiv="pragma" content="no-cache">
<meta http-equiv="cache-control" content="no-cache">
<meta http-equiv="expires" content="0">    
<meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
<meta http-equiv="description" content="This is my page">

<link href="/manage/styles/pictureUpload.css" rel="stylesheet" type="text/css">
<link href="/manage/styles/common.css" rel="stylesheet" type="text/css">
<link href="/dist/css/common-article.css" rel="stylesheet" type="text/css">

<script type="text/javascript" src="/manage/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="/manage/js/my-select.js"></script>
<script type="text/javascript" src="/manage/js/upload_article.js"></script>

</head>
<body>

 	<!-- 用于遮住下层的div -->
    <div class="shield_down_div"></div>
     <div class="uploading_tip">
   		<h4 style="font-size: 16px;">您的作品正在上传中，请耐心等候...</h4>
   		<img alt="等待上传" src="/manage/images/uploading.gif" width="100px" height="100px" class="uploading_image">
    </div>
    <div class="preview">
    	<div class="preview-article"></div>
    	<div class="close">
    		<button class="close-btn" onclick="closePreview()">关闭</button>
    	</div>
    </div>
    	
    <div style="display: block;">
    	<!-- 回到顶端start -->
  		<div class="side-btns-wrap">
  			<div class="side-btns-top">
  				<a href="javascript:;" class="side-btns-top-btn" title="回到顶端"></a>
  			</div>
  		</div>
  		<!-- 回到顶端end -->
  		
  		<div class="wrap">
  			<!-- 顶部start -->
  			<div class="header">
  				<div class="manage-title">
  					<h1>面试厅文章编辑</h1>
  				</div>
  			</div>
  			<!-- 顶部end -->
  			<!-- 上传作品start -->
  			<div class="upload-form">
	  			<div class="upload-wrap up_active">
	  				<div class="up_top cysel">
	  					<p id="upload-style" class="product-style">
	  						作品类型：
	  						<select id="product-article-style" style="display: none;" name="article.category">
	  							<option value="Javascript">Javascript</option>
	  							<option value="HTML5">HTML5</option>
	  							<option value="CSS3">CSS3</option>
	  							<option value="ES6">ES6</option>
	  							<option value="Git">Git</option>
	  							<option value="AngularJS">AngularJS</option>
	  							<option value="Vue">Vue</option>
	  							<option value="React">React</option>
	  							<option value="Webpack">Webpack</option>
	  							<option value="Gulp">Gulp</option>
	  							<option value="NodeJS">NodeJS</option>
	  							<option value="Mysql">Mysql</option>
	  							<option value="synthesize">综合</option>
	  						</select>
	  					</p>
	  					
	  					<p class="product-style">
	  						文章主题：
	  						<input type="text" class="input-text" style="margin-left: 23px;" name="article.title" id="article-title" 
	  					 	     placeholder="请输入文章主题" />
	  						<span style="margin-left: 10px;">*必填项</span>
	  						<span class="error-tip fill-info" id="error-title" style="display: none; color: red;">标红处为必填项</span>
	  					</p>
	  					<p class="product-style">
	  						文章简介：
	  						<input type="text" class="input-text" style="margin-left: 23px;" name="article.description" id="article-description" 
	  					 	     placeholder="请输入文章简介" />
	  					</p>
	  					<!-- 
	  					<p class="product-style">
	  						视频url：
	  						<input type="text" class="input-text" style="margin-left: 33px;" name="article.videoUrl" id="article-videourl" 
	  					 	     placeholder="视频地址" />
	  					</p>
	  					 -->
	  					<p class="product-style">
	  						图片上传
	  						<input type="file" style="margin-left: 33px;" onchange="uploadPic(event)"/>
	  					</p>
	  					<p class="tips">如果文章中有图片要插入，先从这里上传，然后将得到的图片url通过下面的富文本编辑器添加进去</p>
	  					<p class="pic-url" id="return-pic-url"></p>
	  					<p class="product-style">
	  						<span>
	  							文章内容：（*必填项）
	  						</span>
	  						<span class="error-tip fill-info" id="error-content" style="display: none; color: red;">文章内容为必填项</span>
	  					</p>
	  					<div id="article-content" class=""></div>
	  					<div class="up-active-btn">
	  						<input type="button" value="提交" class="submit-btn" onclick="return showUploadingGif();"/>
	  						<a class="submit-btn preview-color" href="javascript:;" onclick="preview()">预览</a>
	  					</div>
	  				</div>
	  			</div>
  			</div>
  			<!-- 上传作品end -->
    	</div>
     </div>
     
     <script type="text/javascript" src="http://mstcdn.oss-cn-shenzhen.aliyuncs.com/scripts/wangEditor.min.js"></script>
     <script type="text/javascript">
	     var E = window.wangEditor;
	     var editor = new E('#article-content');
	     editor.create();
     </script>
     <script type="text/javascript">
     
     /**
      * 首先进行校验填写的内容，校验通过后显示出等待上传的div
      * @return
      */
     function showUploadingGif()
     {
     	//主题
     	var title = $("#article-title").val();
     	var reg = new RegExp("^[0-9]*$");
     	var flag = true;
     	if(!title || title.trim().length == 0)
     	{
     		$("#error-title").show();
     		$("#article-title").css("border", "1px solid red");
     		flag = false;
     	}
     	else
     	{
     		flag = true;
     		$("#error-title").hide();
     		$("#article-title").css("border", "1px solid #ccc");
     	}
     	
     	// 处理下富文本编辑器的内容
    	var result = dealEditorContent(title);
     	flag = flag && result;
     	
     	// 获取请求对象
     	var article = {};
     	article.category = $("#product-article-style").val();
     	article.title = title;
     	article.description = $("#article-description").val();
     	article.videoUrl = $("#article-videourl").val();
     	article.content = result;
     	if(flag) {
     		$(".shield_down_div").show();
     		$(".uploading_tip").show();
         	sendWriteArticleRequest(article);
     	}
     }

     /**
      * 发送请求	
      */
     function sendWriteArticleRequest(article) {
     	$.ajax({
     		type: 'post',
     		url: '/article-json/uploadArticle',
     		data: {
     			"article.category":article.category,
     			"article.title":article.title,
     			"article.description":article.description,
     			"article.videoUrl":article.videoUrl,
     			"article.content":article.content
     		},
     		success: function(response) {
     			var protocol = window.location.protocol;
     			var hostname = window.location.hostname;
     			var port = window.location.port;
     			portVal = port ? ':' + port : port
     			window.location.href = protocol + '//' + hostname + portVal + '/manage/success.html';
     		}
     	});
     }
     
     Date.prototype.Format = function (fmt) { 
   	    var o = {
   	        "M+": this.getMonth() + 1, //月份 
   	        "d+": this.getDate(), //日 
   	        "H+": this.getHours(), //小时 
   	        "m+": this.getMinutes(), //分 
   	        "s+": this.getSeconds(), //秒 
   	        "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
   	        "S": this.getMilliseconds() //毫秒 
   	    };
   	    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
   	    for (var k in o)
   	    if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
   	    return fmt;
    } 
     
     /**
      * 处理富文本编辑器的内容
      */
	function dealEditorContent(title) {
    	var text = editor.txt.text();
    	if(!text || !text.trim().length) {
    		$("#error-content").show();
    		return false;
    	} else {
    		$("#error-content").hide();
    	}
    	 
   		var html = editor.txt.html();
   		// 处理下文本编辑器生成的html
   		html = filterHTML(html);
   		
   		// 给对应的标签加上对应的类
   		// 1.先给最外层加上一个div，article-box类
   		var container = $('<div class="article-box"></div>');
   		// 2.添加一个h1，article-title类
   		var articleTitle = $('<h1 class="article-title"></h1>');
   		articleTitle.text(title);
   		// 3.添加一个sub
   		var currentTime = new Date().Format('yyyy-MM-dd HH:mm:ss');
   		var subStr = '<div class="article-sub"><span class="original">原创</span><span>' + currentTime + '</span></div>';
   		var jQsub = $(subStr);
   		// 4.文章内容
   		var articleContent = $('<div class="article-content"><div>' + html + '</div></div>');
   		
   		container.append(articleContent);
   		container.prepend(jQsub);
   		container.prepend(articleTitle);
   		
   		return container[0].outerHTML;
   	}
     
    /**
     * 处理文本编辑器生成的html
     */
    function filterHTML(html) {
    	// 去掉无用的空行
		html = html.replace(/<p><br><\/p>/g, '');
    	// table加边框
		html = html.replace(/border="0"/g, 'border="1"');
		return html;
    }
     
    /**
     * 预览
     */
	function preview() {
		var title = $("#article-title").val();
     	// 处理下富文本编辑器的内容
    	var result = dealEditorContent(title);
		$(".shield_down_div").show();
		$(".preview-article").html(result);
 		$(".preview").show();
	}
    
    /**
     * 预览关闭
     */
     function closePreview() {
   		 $(".shield_down_div").hide();
  		 $(".preview").hide();
     }
     
    </script>
     
	
</body>
</html>